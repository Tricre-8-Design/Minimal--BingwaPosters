# Revert PesaFlux Integration to M-Pesa

## Goal
Restore the original M-Pesa payment integration by reverting changes from commit `4288fa8`. This includes restoring `lib/mpesa.ts`, reverting API routes, and updating the payment UI.

## Assumptions
- The previous `lib/mpesa.ts` logic (Daraja API) is still valid and functional.
- The necessary environment variables (`MPESA_CONSUMER_KEY`, `MPESA_CONSUMER_SECRET`, etc.) are available in `.env`.
- No database schema changes were made that are incompatible with the old code (both use `payments` table).

## Plan
1. Restore M-Pesa Library
   - Files: `lib/mpesa.ts` (create), `lib/pesaflux.ts` (delete)
   - Change: Create `lib/mpesa.ts` with the original Daraja implementation. Delete `lib/pesaflux.ts`.
   - Verify: `ls lib/mpesa.ts` (should exist), `ls lib/pesaflux.ts` (should not exist).

2. Revert API Routes
   - Files: `app/api/mpesa/initiate/route.ts`, `app/api/mpesa/callback/route.ts`
   - Change: Replace current PesaFlux logic with the original M-Pesa Daraja implementation.
   - Verify: `grep "initiateStkPush" app/api/mpesa/initiate/route.ts` (should find import from `@/lib/mpesa`).

3. Revert Payment UI
   - Files: `app/payment/[sessionId]/page.tsx`
   - Change: Restore the original payment page UI and logic that uses the M-Pesa initiate endpoint.
   - Verify: `grep "PesaFlux" app/payment/[sessionId]/page.tsx` (should return minimal or no results, or match expected old text).

4. Update Documentation & Changelog
   - Files: `README.md`, `CHANGELOG.md`
   - Change: Add a new entry to `CHANGELOG.md` noting the revert. Update `README.md` to reflect M-Pesa usage.
   - Verify: `grep "Revert" CHANGELOG.md`.

## Risks & mitigations
- **Env Vars Missing:** If `MPESA_*` vars were removed, the integration will fail. Mitigation: Verify `.env` content or ask user to check.
- **Dependency Issues:** If `pesaflux` package was installed (unlikely based on file analysis), it might need removal. Mitigation: Check `package.json` for unused dependencies.

## Rollback plan
- Re-apply the changes from commit `4288fa8` manually or use `git revert` on the revert commit.
